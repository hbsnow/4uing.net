<article class="main-root"><header class="content-header"><nav id="breadcrumb"><div class="container"><div itemscope="itemscope" itemtype="http://data-vocabulary.org/Breadcrumb"><a href="/blog.html" itemprop="url"><span itemprop="title">Blog</span></a></div></div></nav><div class="content-header-title"><div class="container"><h1 id="main-title">LalavelからサービスアカウントでGoogle Driveのファイル情報を取得する</h1></div></div><div class="content-header-meta"><div class="container"><div id="article-date"><div id="article-date-created"><time>2015-03-18</time></div><hr/><div id="article-date-updated"><time>2015-04-13</time></div></div><div id="article-tags"><ul><li><a href="/blog/tag/PHP.html" class="button">PHP</a></li><li><a href="/blog/tag/Laravel.html" class="button">Laravel</a></li></ul></div><div id="article-toc"><div class="container"><ol><li><a href="#install">ライブラリのインストール</a></li><li><a href="#drive-api">Drive API</a></li><li><a href="#class">クラスの作成</a></li><li><a href="#caution">注意すべきこと</a></li><li><a href="#bibliography">参照文献</a></li></ol></div></div></div></div></header><div class="content-body"><div class="container"><div class="paragraph">
<p><a href="https://github.com/hbsnow/laravel5-blog">以前ののブログ</a>はすべてGoogle Driveで、記事ごとによるディレクトリ単位で管理されていました。例えばこの記事だと<code>root\public\4uing\blog\LalavelからGoogle Driveのファイル情報を取得する</code>にある<code>index.md</code>、ここでは使われていないけれど記事内に画像などがあれば、それらのファイルも当然そのディレクトリに含まれることになります。</p>
</div>
<div class="paragraph">
<p>これまで<code>index.md</code>の呼び出しは、単純に以下のように行っていました。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-php" data-lang="php">file_get_contents(<span class="hljs-string">'https://drive.google.com/uc?export=view&amp;id='</span> . <span class="hljs-variable">$file_id</span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>ファイルの内容だけ欲しいときはこれでもいいんだけど、更新についての情報だったりタイトルになる親のディレクトリ名や最終更新日時などを取得できるわけではないので、それらを取得するためには以下の方法をとる必要があります。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>データベースに保存しておく</p>
</li>
<li>
<p>Google Drive APIを使ってその都度データを取得する</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>すべてのデータをデータベースに保存しておいてももちろん問題ないんだけど、自分はMarkdownのファイル内にはメタデータを記述したくなかったので結局データベースに保存するにもGoogle Drive APIでデータを取得する必要がありました。</p>
</div>
<div class="sect1">
<h2 id="install">ライブラリのインストール</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Google APIにアクセスするためのライブラリを<code>composer require google/apiclient</code>でインストールします。</p>
</div>
<div class="paragraph">
<p>githubではgoogle-api-php-clientなんだけどpackegistではapiclientになっているので、packegistで検索してもなかなか見つけられないと思う、自分がそうだった。</p>
</div>
<div class="paragraph">
<p>あとはautoloadに以下を追加して<code>composer update</code>。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json"><span class="hljs-string">"autoload"</span>: {
  "<span class="hljs-attribute">classmap</span>": <span class="hljs-value">[
    ...
    <span class="hljs-string">"vendor/google/apiclient/src/Google"</span>
  ]</span>,
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="drive-api">Drive API</h2>
<div class="sectionbody">
<div class="paragraph">
<p>情報を取得するにはDrive APIを利用する必要があります。<a href="https://console.developers.google.com/">Google Developers Console</a>のAPIと認証からDrive APIを有効にします。</p>
</div>
<div class="paragraph">
<p>認証のOAuthで新しいクライアントIDを作成します。今回の目的はユーザに認証を求めるようなウェブアプリケーションではないので、サービスアカウントを作ることになります。キーが発行されるので、発行された<code>.p12</code>を適当なフォルダに移動します。自分の場合は<code>resources\assets\</code>にしました。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="class">クラスの作成</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Google Driveにアクセスするためのクラスを作成します。<a href="https://laracasts.com/discuss/channels/tips/google-api-service-account-connection-laravel-5">Google カレンダーでのコード</a>があったのでほとんどそのまま使わせてもらいました。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-php" data-lang="php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GoogleDrive</span>
</span>{
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$service</span>;
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$file</span>;

    <span class="hljs-comment">/**
     * コンストラクタ
     *
     * <span class="hljs-doctag">@param</span> $file_id 読み込むファイルのID
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(<span class="hljs-variable">$file_id</span>)</span>
    </span>{
        <span class="hljs-variable">$service_account_name</span> = <span class="hljs-string">'XXX@developer.gserviceaccount.com'</span>;
        <span class="hljs-variable">$key_file_location</span> = base_path() . <span class="hljs-string">'/resources/assets/XXX.p12'</span>;

        <span class="hljs-variable">$client</span> = <span class="hljs-keyword">new</span> \Google_Client();
        <span class="hljs-variable">$this</span>-&gt;service = <span class="hljs-keyword">new</span> \Google_Service_Drive(<span class="hljs-variable">$client</span>);

        <span class="hljs-keyword">if</span> (Cache::has(<span class="hljs-string">'service_token'</span>))
        {
            <span class="hljs-variable">$client</span>-&gt;setAccessToken(Cache::get(<span class="hljs-string">'service_token'</span>));
        }

        <span class="hljs-variable">$key</span> = file_get_contents(<span class="hljs-variable">$key_file_location</span>);
        <span class="hljs-variable">$scopes</span> = [<span class="hljs-string">'https://www.googleapis.com/auth/drive'</span>];

        <span class="hljs-variable">$auth</span> = <span class="hljs-keyword">new</span> \Google_Auth_AssertionCredentials(<span class="hljs-variable">$service_account_name</span>, <span class="hljs-variable">$scopes</span>, <span class="hljs-variable">$key</span>);

        <span class="hljs-variable">$client</span>-&gt;setAssertionCredentials(<span class="hljs-variable">$auth</span>);

        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$client</span>-&gt;getAuth()-&gt;isAccessTokenExpired())
        {
            <span class="hljs-variable">$client</span>-&gt;getAuth()-&gt;refreshTokenWithAssertion(<span class="hljs-variable">$auth</span>);
        }

        Cache::forever(<span class="hljs-string">'service_token'</span>, <span class="hljs-variable">$client</span>-&gt;getAccessToken());

        <span class="hljs-variable">$this</span>-&gt;file = <span class="hljs-variable">$this</span>-&gt;service-&gt;files-&gt;get(<span class="hljs-variable">$file_id</span>);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>あとは使いそうなメソッドを適当に追加していけばいいんだけど、ドキュメントがなんかなさそうなので結構コードをみながら作らないといけないのでわりと面倒でした。やりたいことを検索しても一年前の情報ですら参考にならなかったりするので結構大変。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="caution">注意すべきこと</h2>
<div class="sectionbody">
<div class="paragraph">
<p>気をつけなければいけないのは、サービスアカウントを使ったログインではそのサービスアカウントで作成したファイルのリストしか取得できないということ。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-php" data-lang="php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getFileList</span><span class="hljs-params">(<span class="hljs-variable">$folder_id</span>)</span>
</span>{
    <span class="hljs-variable">$children</span> = <span class="hljs-variable">$this</span>-&gt;service-&gt;children-&gt;listChildren(<span class="hljs-variable">$folder_id</span>);

    <span class="hljs-keyword">return</span> <span class="hljs-variable">$children</span>-&gt;getItems();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>例えばこのようなメソッドは、認証済みの自分のGoogle Driveの子フォルダを含むフォルダのIDを指定しても、その子フォルダがすべてアプリケーションで作成したものでないなら、空の配列が返されることになります。</p>
</div>
<div class="paragraph">
<p>リストが取得できないというだけで、親フォルダのディレクトリ名のようなものであれば取得できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-php" data-lang="php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getTitle</span><span class="hljs-params">(<span class="hljs-variable">$file_id</span>)</span>
</span>{
    <span class="hljs-variable">$results</span> = <span class="hljs-variable">$this</span>-&gt;service-&gt;files-&gt;get(<span class="hljs-variable">$file_id</span>);
    <span class="hljs-variable">$parent_id</span> = <span class="hljs-variable">$results</span>-&gt;parents[<span class="hljs-number">0</span>]-&gt;getID();

    <span class="hljs-keyword">return</span> <span class="hljs-variable">$this</span>-&gt;service-&gt;files-&gt;get(<span class="hljs-variable">$parent_id</span>)-&gt;getTitle();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>ただどうしてこれが取得できるのかは正直ちょっとよくわからない、どこかに書いてそうではあるけど。そもそも<code>$results→parents</code>で取得できるのは本来親フォルダの所属するディレクトリの全ファイルっぽい感じのところが、実際に取得できているのが親フォルダだけなので、親のディレクトリだけは参照できるということなのかもしれない。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="bibliography">参照文献</h2>
<div class="sectionbody">
<div class="ulist bibliography">
<ul class="bibliography">
<li>
<p><a href="https://developers.google.com/api-client-library/php/start/installation">Installation - Google APIs Client Library for PHP — Google Developers</a></p>
</li>
<li>
<p><a href="https://laracasts.com/discuss/channels/tips/google-api-service-account-connection-laravel-5">Google API - Service account connection - Laravel 5</a></p>
</li>
</ul>
</div>
</div>
</div></div></div></article>