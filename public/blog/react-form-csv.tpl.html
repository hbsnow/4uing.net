<article class="main-root"><header class="content-header"><nav id="breadcrumb"><div class="container"><div itemscope="itemscope" itemtype="http://data-vocabulary.org/Breadcrumb"><a href="/blog.html" itemprop="url"><span itemprop="title">Blog</span></a></div></div></nav><div class="content-header-title"><div class="container"><h1 id="main-title">Reactを使ってフォームで選択したCSVファイルを表示する</h1></div></div><div class="content-header-meta"><div class="container"><div id="article-date"><div id="article-date-created"><time>2015-05-10</time></div></div><div id="article-tags"><ul><li><a href="/blog/tag/JavaScript.html" class="button">JavaScript</a></li><li><a href="/blog/tag/React.html" class="button">React</a></li></ul></div><div id="article-toc"><div class="container"><ol><li><a href="#preparation">Reactを使うための前準備</a></li><li><a href="#show-csv">フォームで指定されたCSVデータをReactを使って表示する</a></li><li><a href="#parse-csv">CSVをパースしてテーブルで表示する</a></li><li><a href="#flux">実装をFluxにする</a></li><li><a href="#bibliography">参照文献</a></li></ol></div></div></div></div></header><div class="content-body"><div class="container"><div class="paragraph">
<p><a href="https://facebook.github.io/react/">React</a>を使って<code>&lt;input type="file"&gt;</code>で指定された以下のCSVを表示してみます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-csv" data-lang="csv">背番号,名前
1,陽岱鋼
2,大野奨太
3,田中賢介</code></pre>
</div>
</div>
<div class="paragraph">
<p>背番号は重複することのないユニークなIDです。</p>
</div>
<div class="sect1">
<h2 id="preparation">Reactを使うための前準備</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Reactを使うために使用する必要最低限のものをリストアップをしていきます。BabelがJSXを標準でサポートしているので、使用するテンプレートエンジンはJSXを使います。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://facebook.github.io/react/">React</a></p>
</li>
<li>
<p><a href="http://gulpjs.com/">gulp</a></p>
</li>
<li>
<p><a href="https://babeljs.io/">babel</a></p>
</li>
<li>
<p><a href="http://webpack.github.io/">webpack</a></p>
</li>
<li>
<p><a href="https://github.com/babel/babel-loader">babel-loader</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Reactの比較的新しいサンプルコードの多くにはBabelが使われているので、<a href="https://babeljs.io/docs/learn-es6/">BabelのLearn ES6</a>を先に読んでおいたほうがいいとおもう。</p>
</div>
<div class="paragraph">
<p><code>gulpfile.js</code>のタスクはこんな感じです。かなり省略してるので実際に使っているのとはだいぶ違うし、この程度であればgulpを通す必要はないとおもう。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">gulp.task(<span class="hljs-string">'build:js'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> js = <span class="hljs-string">'./src/scripts/main.jsx'</span>;
  <span class="hljs-keyword">var</span> loader = {
    loaders: [
      {
        test: <span class="hljs-regexp">/\.jsx$/</span>,
        loader: <span class="hljs-string">'babel-loader?stage=0'</span>
      }
    ]
  }

  <span class="hljs-keyword">return</span> gulp.src(js)
    .pipe($.webpack({
      output: {
        filename: <span class="hljs-string">'[name].js'</span>
      },
      <span class="hljs-built_in">module</span>: loader
    }))
    .pipe(gulp.dest(<span class="hljs-string">'./build/'</span>))
});</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="show-csv">フォームで指定されたCSVデータをReactを使って表示する</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>&lt;input type="file"&gt;</code>で指定されたCSVのファイルの内容を表示させてみます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">let</span> App = React.createClass({
  getInitialState() {
    <span class="hljs-keyword">return</span> {
      csv: <span class="hljs-string">''</span>
    };
  },
  handleFile(e) {
    <span class="hljs-keyword">let</span> reader = <span class="hljs-keyword">new</span> FileReader();
    reader.readAsText(e.target.files[<span class="hljs-number">0</span>]);
    reader.onload = (upload) =&gt; {
      <span class="hljs-keyword">this</span>.setState({
        csv: upload.target.result
      });
    };
  },
  render() {
    <span class="hljs-keyword">return</span> (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">className</span>=<span class="hljs-value">"app"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">form</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-title">input</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"file"</span> <span class="hljs-attribute">onChange</span>=<span class="hljs-value">{this.handleFile}</span> <span class="hljs-attribute">accept</span>=<span class="hljs-value">".csv"</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-title">form</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">pre</span>&gt;</span>{this.state.csv}<span class="hljs-tag">&lt;/<span class="hljs-title">pre</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
    )</span>;
  }
});

React.render(<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-title">App</span> /&gt;</span>, document.body);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>エラー処理は後で追加していくとして、これで選択されたCSVの内容を表示することができました。<code>let</code>だったり<code>=&gt;</code>はBabelというかES6の記述です。</p>
</div>
<div class="paragraph">
<p><code>let</code>はブロックスコープをもつことができて、要するにVBだったりC#の変数っぽくなります。おかげで<code>var</code>を使うことがほとんどなくなりました。</p>
</div>
<div class="paragraph">
<p><code>=&gt;</code>はArrow Functionとよばれるもので、自分はエラーがでるまでただの糖衣構文だとおもっていたんだけど実はそうではありませんでした。例えば上のコードの<code>handleFile</code>の部分を書き直すと次のようになります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">handleFile: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
  <span class="hljs-keyword">var</span> reader = <span class="hljs-keyword">new</span> FileReader();

  reader.readAsText(e.target.files[<span class="hljs-number">0</span>]);

  reader.onload = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">upload</span>) </span>{
    self.setState({
      csv: upload.target.result
    });
  };
},</code></pre>
</div>
</div>
<div class="paragraph">
<p>この二つを比較するとArrow Functionはレキシカルスコープを維持してくれている、ということがわかりやすいかもしれない。<code>var self = this;</code>みたいなことをする必要がなくなって嬉しい感じ。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="parse-csv">CSVをパースしてテーブルで表示する</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>&lt;pre&gt;</code>で表示するだけではプレビューの表示としてわかりにくいので、<code>&lt;table&gt;</code>できれいに表示させてみます。CSVをJSON形式のオブジェクトにパースするため、<a href="https://github.com/mholt/PapaParse">PapaParse</a>を使いました。</p>
</div>
<div class="paragraph">
<p>とりあえずサンプルなのでCSVが認識可能な形式になっているかどうかの判定などの処理はしていません。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> Papa <span class="hljs-keyword">from</span> <span class="hljs-string">'papaparse'</span>;

<span class="hljs-keyword">let</span> PlayerTbody = React.createClass({
  render() {
    <span class="hljs-keyword">let</span> cell = <span class="hljs-keyword">this</span>.props.players.map((player) =&gt; {
      <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-title">tr</span> <span class="hljs-attribute">key</span>=<span class="hljs-value">{player.id}</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-title">td</span>&gt;</span>{player.id}<span class="hljs-tag">&lt;/<span class="hljs-title">td</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-title">td</span>&gt;</span>{player.name}<span class="hljs-tag">&lt;/<span class="hljs-title">td</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-title">tr</span>&gt;</span>
      )</span>;
    });

    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-title">tbody</span>&gt;</span>{cell}<span class="hljs-tag">&lt;/<span class="hljs-title">tbody</span>&gt;</span>;</span>
  }
});

<span class="hljs-keyword">let</span> PlayerPreview = React.createClass({
  render() {
    <span class="hljs-keyword">let</span> preview = <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-title">p</span>&gt;</span>CSVを選択してください。<span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span>;</span>

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.props.players.length &gt; <span class="hljs-number">0</span>) {
      preview = (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-title">table</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-title">thead</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">tr</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-title">td</span>&gt;</span>背番号<span class="hljs-tag">&lt;/<span class="hljs-title">td</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-title">td</span>&gt;</span>名前<span class="hljs-tag">&lt;/<span class="hljs-title">td</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-title">tr</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-title">thead</span>&gt;</span>

          <span class="hljs-tag">&lt;<span class="hljs-title">PlayerTbody</span> <span class="hljs-attribute">players</span>=<span class="hljs-value">{this.props.players}</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-title">table</span>&gt;</span>
      )</span>;
    }

    <span class="hljs-keyword">return</span> (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">className</span>=<span class="hljs-value">"preview"</span>&gt;</span>
        {preview}
      <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
    )</span>;
  }
});

<span class="hljs-keyword">let</span> PlayerForm = React.createClass({
  _onChange(e) {
    <span class="hljs-keyword">this</span>.props.onChange(e);
  },
  render() {
    <span class="hljs-keyword">return</span> (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-title">form</span> <span class="hljs-attribute">encType</span>=<span class="hljs-value">"multipart/form-data"</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"player-form"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">className</span>=<span class="hljs-value">"form-group"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-title">input</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"file"</span> <span class="hljs-attribute">accept</span>=<span class="hljs-value">".csv"</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"player-form-csv"</span>
                 <span class="hljs-attribute">onChange</span>=<span class="hljs-value">{this._onChange}</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-title">form</span>&gt;</span>
    )</span>;
  }
});

<span class="hljs-keyword">let</span> Players = React.createClass({
\tgetInitialState() {
    <span class="hljs-keyword">return</span> {
      players: []
    };
  },
  handleChange(e) {
    <span class="hljs-keyword">let</span> reader = <span class="hljs-keyword">new</span> FileReader();

    reader.readAsText(e.target.files[<span class="hljs-number">0</span>]);

    reader.onload = (upload) =&gt; {
      <span class="hljs-keyword">let</span> csv = upload.target.result.replace(
        <span class="hljs-string">'背番号,名前'</span>,
        <span class="hljs-string">'id,name'</span>
      );

      <span class="hljs-keyword">let</span> json = Papa.parse(csv, { header: <span class="hljs-literal">true</span> });

      <span class="hljs-keyword">this</span>.setState({
        players: json.data
      });
    };
  },
  render() {
    <span class="hljs-keyword">return</span> (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">className</span>=<span class="hljs-value">"players"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">PlayerForm</span> <span class="hljs-attribute">onChange</span>=<span class="hljs-value">{this.handleChange}</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">PlayerPreview</span> <span class="hljs-attribute">players</span>=<span class="hljs-value">{this.state.players}</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
    )</span>;
  }
});

<span class="hljs-keyword">let</span> App = React.createClass({
  render() {
    <span class="hljs-keyword">return</span> (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">className</span>=<span class="hljs-value">"app"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">Players</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
    )</span>;
  }
});

React.render(<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-title">App</span> /&gt;</span>, document.body);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>コードが一気に増えましたが、CSVのパースというよりも<code>&lt;table&gt;</code>を表示するためのコードが多いだけでやっていることは前項のものとそれほど変わりありません。</p>
</div>
<div class="paragraph">
<p>ただこれは<code>&lt;PlayerForm onChange={this.handleChange} /&gt;</code>みたいなものが単純なフォームだからこそ問題ないように見えているだけで、入力項目が複数あるようなフォームで同じようなコードを書くと酷いことになることが簡単に想像できます。それに階層が深くなっていくと<code>state</code>をもつコンポーネントと表示するコンポーネントの関係がわかりにくくなりそうだし、それを継承していくのも面倒になりそうで、とてもこんな記述でコードを書き進めようとはおもえなかった。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="flux">実装をFluxにする</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Fluxについては以下のサイトやスライドを見ながら覚えていきました。とくに<a href="http://azu.github.io/slide/react-meetup/flux.html">10分で実装するFlux</a>のスライドがわかりやすかった。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://azu.github.io/slide/react-meetup/flux.html">10分で実装するFlux</a></p>
</li>
<li>
<p><a href="https://facebook.github.io/flux/">flux</a></p>
</li>
<li>
<p><a href="http://qiita.com/koba04/items/b32ba449d753fdb2b597">reactjs - React.jsとFlux - Qiita</a></p>
</li>
<li>
<p><a href="http://yutapon.hatenablog.com/entry/2015/04/27/150000">React+FluxでTodoMVCを作ってFluxについて学んでみた</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>ただ単純なサンプルでもある程度の前提知識がないと、理解するまでには時間がかかるとおもう。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/hbsnow/react-flux-example">hbsnow/react-flux-example</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>コード量が多くなるのでgithubにコードをあげておきました。この規模であればそれほど問題にはならなかったんだけれども、処理が増えていくとStoreがかなり肥大化していきそうな気がする。</p>
</div>
<div class="paragraph">
<p>作っているときにも結構わからないことがあって、<code>&lt;PlayerPreview&gt;</code>初期ロード時の<code>&lt;table&gt;</code>を出力しない場合の処理なんかはこれが正しい実装方法だとはあまりおもえなかったんだけど、これ以外の方法がおもいつかなかった。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="bibliography">参照文献</h2>
<div class="sectionbody">
<div class="ulist bibliography">
<ul class="bibliography">
<li>
<p><a href="http://qiita.com/advent-calendar/2014/reactjs">一人React.js Advent Calendar 2014 - Qiita</a></p>
</li>
<li>
<p><a href="http://azu.github.io/slide/react-meetup/flux.html">10分で実装するFlux</a></p>
</li>
<li>
<p><a href="http://yutapon.hatenablog.com/entry/2015/04/27/150000">React+FluxでTodoMVCを作ってFluxについて学んでみた</a></p>
</li>
</ul>
</div>
</div>
</div></div></div></article>