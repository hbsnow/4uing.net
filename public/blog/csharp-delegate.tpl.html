<article class="main-root"><header class="content-header"><nav id="breadcrumb"><div class="container"><div itemscope="itemscope" itemtype="http://data-vocabulary.org/Breadcrumb"><a href="/blog.html" itemprop="url"><span itemprop="title">Blog</span></a></div></div></nav><div class="content-header-title"><div class="container"><h1 id="main-title">デリゲートとラムダ式</h1></div></div><div class="content-header-meta"><div class="container"><div id="article-date"><div id="article-date-created"><time>2014-12-16</time></div><hr/><div id="article-date-updated"><time>2015-04-02</time></div></div><div id="article-tags"><ul><li><a href="/blog/tag/C-Sharp.html" class="button">C Sharp</a></li></ul></div><div id="article-toc"><div class="container"><ol><li><a href="#delegate-example">デリゲートのサンプル</a></li><li><a href="#multicasting">マルチキャスティング</a></li><li><a href="#named-method">名前付きメソッドの使用</a></li><li><a href="#lambda">ラムダ式</a></li><li><a href="#generic-delegates">汎用デリゲート</a></li><li><a href="#bibliography">参照文献</a></li></ol></div></div></div></div></header><div class="content-body"><div class="container"><div class="paragraph">
<p>デリゲートについて調べても大体が処理の委譲です、といったような解説がされていて理解できないので自分用にメモを残しておく。</p>
</div>
<div class="sect1">
<h2 id="delegate-example">デリゲートのサンプル</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://msdn.microsoft.com/ja-jp/library/ms173172.aspx">MSDNのデリゲートの解説</a>にまず最初にのっているサンプルのコードがこれ。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cs" data-lang="cs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MainWindow</span>(<span class="hljs-params"></span>)
</span>{
    InitializeComponent();

    <span class="hljs-comment">// Instantiate the delegate.</span>
    Del handler = DelegateMethod;

    <span class="hljs-comment">// Call the delegate.</span>
    handler(<span class="hljs-string">"Hello World"</span>);
}

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">delegate</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Del</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> message</span>)</span>;

<span class="hljs-comment">// Create a method for a delegate.</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">DelegateMethod</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> message</span>)
</span>{
    Console.WriteLine(message);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>コードそのものは理解できるんだけど、何でこんなインスタンス生成してメソッドを呼び出してるのかの理由がわからない。でも意味がないわけがないので次のサンプルを見てみる。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cs" data-lang="cs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MainWindow</span>(<span class="hljs-params"></span>)
</span>{
    InitializeComponent();

    <span class="hljs-comment">// Instantiate the delegate.</span>
    Del handler = DelegateMethod;

    <span class="hljs-comment">// Call the delegate.</span>
    MethodWithCallback(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, handler);
}

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">delegate</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Del</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> message</span>)</span>;

<span class="hljs-comment">// Create a method for a delegate.</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">DelegateMethod</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> message</span>)
</span>{
    System.Console.WriteLine(message);
}

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">MethodWithCallback</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> param1, <span class="hljs-keyword">int</span> param2, Del callback</span>)
</span>{
    callback(<span class="hljs-string">"The number is: "</span> + (param1 + param2).ToString());
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>これをみるとちょっとすごいっぽい雰囲気は伝わってくる。どうやらメソッド内で実行される関数を後から変えることができるものらしい。例えばメッセージの表示方法を<code>System.Console.WriteLine</code>から<code>System.Diagnostics.Debug.WriteLine</code>に変えたりできるようです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cs" data-lang="cs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MainWindow</span>(<span class="hljs-params"></span>)
</span>{
    InitializeComponent();

    Del handler1 = DelegateMethod1;
    MethodWithCallback(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, handler1);

    Del handler2 = DelegateMethod2;
    MethodWithCallback(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, handler2);
}

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">delegate</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Del</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> message</span>)</span>;

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">DelegateMethod1</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> message</span>)
</span>{
    System.Console.WriteLine(message);
}

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">DelegateMethod2</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> message</span>)
</span>{
    System.Diagnostics.Debug.WriteLine(message);
}

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">MethodWithCallback</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> param1, <span class="hljs-keyword">int</span> param2, Del callback</span>)
</span>{
    callback(<span class="hljs-string">"The number is: "</span> + (param1 + param2).ToString());
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="multicasting">マルチキャスティング</h2>
<div class="sectionbody">
<div class="paragraph">
<p>次に説明されているのがマルチキャスティングというもの。まずこんなクラスがサンプルにあります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cs" data-lang="cs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MethodClass</span>
{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Method1</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> message</span>) </span>{ }
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Method2</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> message</span>) </span>{ }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>いくらサンプルっていっても、さすがにもうちょっとやる気だせよと言いたくなる。で、次はこれ。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cs" data-lang="cs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MainWindow</span>(<span class="hljs-params"></span>)
</span>{
    InitializeComponent();

    MethodClass obj = <span class="hljs-keyword">new</span> MethodClass();
    Del d1 = obj.Method1;
    Del d2 = obj.Method2;
    Del d3 = DelegateMethod;

    <span class="hljs-comment">//Both types of assignment are valid.</span>
    Del allMethodsDelegate = d1 + d2;
    allMethodsDelegate += d3;
}

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">delegate</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Del</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> message</span>)</span>;

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">DelegateMethod</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> message</span>)
</span>{
    System.Console.WriteLine(message);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>このサンプル、理解させる気があるとは思えない。せめて最後に<code>allMethodsDelegate("Hello World");</code>くらいつけたらよかったんじゃないだろうか。でもそんなものつけたところでこのサンプルだとさっぱりわからないことに変わりはないので、ここでは別にサンプルを用意する。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cs" data-lang="cs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MethodClass</span>
{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Method1</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> message</span>)
    </span>{
        System.Console.WriteLine(<span class="hljs-string">"Method1: {0}"</span>, message);
    }
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Method2</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> message</span>)
    </span>{
        System.Console.WriteLine(<span class="hljs-string">"Method2: {0}"</span>, message);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>メソッドが呼び出されたときにはどのメソッドが呼び出されたかをコンソールに出力するようにした。あとは最後に<code>allMethodsDelegate("Hello World");</code>を加えると次のような感じでコンソールに出力される。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Method1: Hello World
Method2: Hello World
Hello World</code></pre>
</div>
</div>
<div class="paragraph">
<p>どうやらマルチキャスティングというのは複数のデリゲートを代入した順番で呼び出すものらしい。普通にサンプル作って欲しかった。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cs" data-lang="cs"><span class="hljs-comment">//remove Method1</span>
allMethodsDelegate -= d1;

<span class="hljs-comment">// copy AllMethodsDelegate while removing d2</span>
Del oneMethodDelegate = allMethodsDelegate - d2;</code></pre>
</div>
</div>
<div class="paragraph">
<p>あとはこういうこともできるみたいです。ここまでくると直感的でわかりやすいなと思える。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="named-method">名前付きメソッドの使用</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://msdn.microsoft.com/ja-jp/library/98dc08ac.aspx">MSDNの解説では名前付きメソッドの使用</a>になっているんだけれども、いままでやっていたのが名前付きメソッドの使用でなんでこんな項目があるのかよくわからない。むしろこれまで匿名メソッドを使ったサンプルがなかったのでここでは匿名メソッドを使ったサンプルを確認しておく。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cs" data-lang="cs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MainWindow</span>(<span class="hljs-params"></span>)
</span>{
    InitializeComponent();

    Del d = <span class="hljs-keyword">delegate</span>(<span class="hljs-keyword">string</span> message) {
        System.Console.WriteLine(message);
    };

    d(<span class="hljs-string">"Hello World"</span>);
}

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">delegate</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Del</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> message</span>)</span>;</code></pre>
</div>
</div>
<div class="paragraph">
<p>名前付きとか匿名とか用語をみると何をいっているのかわかりにくいけども、実際にコードをみると、名前付きってそういうことかと理解できるはず。単にそのメソッドに名前がついてるかついてないかの違いしかない。</p>
</div>
<div class="paragraph">
<p>ここではさらっとしか書かないけどラムダ式も使える。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cs" data-lang="cs">Del d = message =&gt; { Console.WriteLine(message); };</code></pre>
</div>
</div>
<div class="paragraph">
<p>実際のコードでみかけるのはラムダ式ばかりで、デリゲート自体理解してないとコードすべて理解できないという残念なことになる。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="lambda">ラムダ式</h2>
<div class="sectionbody">
<div class="paragraph">
<p>ラムダ式をまったく理解していない状態でラムダ式について調べると、たぶん何がなんだか理解できないとおもう。ただラムダ式という言葉はしらなくてもJavaScriptで匿名関数は使ったことがあるかもしれない。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js"><span class="hljs-keyword">var</span> show = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">message</span>)</span>{ Console.log(message); }
show(<span class="hljs-string">"Hello World"</span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>かつての自分はこれを見てJavaScript気持ち悪いな、と思っていたんだけどJavaScriptは悪くない。匿名関数とデリゲートを理解してなかった自分が悪かった。</p>
</div>
<div class="paragraph">
<p>JavaScriptはとりあえずおいといて、今はC#でこれと似たようなことはできないのかという話。C#で匿名関数っていうと匿名メソッドとラムダ式のことをさしているんですが、これは匿名メソッド。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cs" data-lang="cs">Del d = <span class="hljs-keyword">delegate</span>(<span class="hljs-keyword">string</span> message) {
    System.Console.WriteLine(message);
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>最初に書いたJavaScriptのコードとそっくりですよねこれ。でもC#では基本こんな書き方はあんまりしなくて、だいたい次のように書きます。これがラムダ式。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cs" data-lang="cs">Del d = message =&gt; { Console.WriteLine(message); };</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>⇒</code>はラムダ演算子っていうそうです。この左辺にあるmessageは入力パラメーターで複数あったりなかったりすることもあります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cs" data-lang="cs">(x, y) =&gt; { Console.WriteLine(x + y); };
() =&gt; { Console.WriteLine(<span class="hljs-string">"パラメータがないよ！"</span>); };</code></pre>
</div>
</div>
<div class="paragraph">
<p>右辺にあるのは式もしくはステートメントで見ればわかる。</p>
</div>
<div class="paragraph">
<p>ラムダ式があれば匿名メソッドの記法いらないじゃんって思うかもしれないんだけど、これが実装されたのは.NET3以降らしいのでそういう事情なんでしょう。細かい挙動の違いみたいなものもあるみたいですけど、基本的にラムダ式使えばいい感じっぽいです。</p>
</div>
<div class="paragraph">
<p>当然のことなんだけど、デリゲートがわかってないとラムダ式も理解できない。でも前面にでてくる言葉がラムダ式だからラムダ式でばかり検索しちゃうんだよね。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="generic-delegates">汎用デリゲート</h2>
<div class="sectionbody">
<div class="paragraph">
<p>汎用デリゲートと書くと何のことだかわからないけども、<code>Action</code>と<code>Func</code>と書くとなんだそれかとなる人もいるかもしれない。汎用という名前が付いているところからわかるように汎用的に使えるデリゲート用の型で、これまでのコードは次のように簡単に記述することができる。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cs" data-lang="cs">Action&lt;<span class="hljs-keyword">string</span>&gt; d = message =&gt; { Console.WriteLine(message); };
d(<span class="hljs-string">"Hello World"</span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>何が不要になったかというとデリゲートの宣言。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cs" data-lang="cs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">delegate</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Del</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> message</span>)</span>;</code></pre>
</div>
</div>
<div class="paragraph">
<p>これがいらなくなる。<code>Action</code>の右隣にいる<code>&lt;string&gt;</code>はパラメータの型。</p>
</div>
<div class="paragraph">
<p><code>Action</code>と<code>Func</code>の違いは戻り値の有無で、戻り値があるようなものの場合には<code>Func</code>を使う。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cs" data-lang="cs">Func&lt;<span class="hljs-keyword">int</span>, <span class="hljs-keyword">int</span>, <span class="hljs-keyword">int</span>&gt; add = (x, y) =&gt; x + y;
Console.WriteLine(add(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>));</code></pre>
</div>
</div>
<div class="paragraph">
<p>パラメータが3つもあるのはもっとも右辺にあるのが戻り値の型になるから。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="bibliography">参照文献</h2>
<div class="sectionbody">
<div class="ulist bibliography">
<ul class="bibliography">
<li>
<p><a href="https://msdn.microsoft.com/ja-jp/library/ms173171.aspx">デリゲート (C# プログラミング ガイド)</a></p>
</li>
<li>
<p><a href="https://msdn.microsoft.com/ja-jp/library/0yw3tz5k.aspx">匿名メソッド (C# プログラミング ガイド)</a></p>
</li>
<li>
<p><a href="https://msdn.microsoft.com/ja-jp/library/bb882516.aspx">匿名関数 (C# プログラミング ガイド)</a></p>
</li>
</ul>
</div>
</div>
</div></div></div></article>