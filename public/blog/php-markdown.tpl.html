<article class="main-root"><header class="content-header"><nav id="breadcrumb"><div class="container"><div itemscope="itemscope" itemtype="http://data-vocabulary.org/Breadcrumb"><a href="/blog.html" itemprop="url"><span itemprop="title">Blog</span></a></div></div></nav><div class="content-header-title"><div class="container"><h1 id="main-title">PHPで使うMarkdownのパーサを変更した</h1></div></div><div class="content-header-meta"><div class="container"><div id="article-date"><div id="article-date-created"><time>2015-02-26</time></div><hr/><div id="article-date-updated"><time>2015-04-02</time></div></div><div id="article-tags"><ul><li><a href="/blog/tag/PHP.html" class="button">PHP</a></li><li><a href="/blog/tag/Markdown.html" class="button">Markdown</a></li></ul></div><div id="article-toc"><div class="container"><ol><li><a href="#install">インストール</a></li><li><a href="#add-class">クラスの追加</a></li><li><a href="#edit-fcb">FencedCodeBlockの修正</a></li><li><a href="#generate-toc">ページ内メニューを生成する</a></li></ol></div></div></div></div></header><div class="content-body"><div class="container"><div class="paragraph">
<p>これまでPHPのときのMarkdownのパースにはParsedownを使っていたんだけども、ちょっと拡張がしにくい感じがしたので、Laravel5に移行するついでに拡張がしやすいらしい<a href="https://github.com/cebe/markdown">markdown</a>に変更してみました。噂通り本当に色々と変更がしやすかったので今後はmarkdownを使うことが多くなりそう。</p>
</div>
<div class="paragraph">
<p>以下はLaravelで使う方法。</p>
</div>
<div class="sect1">
<h2 id="install">インストール</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>composer.json</code>の<code>require</code>に以下を追加する。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json"><span class="hljs-string">"require"</span>: {
  "<span class="hljs-attribute">cebe/markdown</span>": <span class="hljs-value"><span class="hljs-string">"~1.0.1"</span>
</span>},</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>composer update</code>でアップデートして終了。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="add-class">クラスの追加</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>app\Classes\Markdown\MyMarkdown.php</code>を作成。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-php" data-lang="php"><span class="hljs-preprocessor">&lt;?php</span> <span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Classes</span>\<span class="hljs-title">Markdown</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">cebe</span>\<span class="hljs-title">markdown</span>\<span class="hljs-title">GithubMarkdown</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyMarkdown</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GithubMarkdown</span> </span>{
    <span class="hljs-comment">//</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>あとはここに追加していくだけ。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="edit-fcb">FencedCodeBlockの修正</h2>
<div class="sectionbody">
<div class="paragraph">
<p>使ってみて気になったのが、FencedCodeBlock内のTab文字がそのまま出力されてしまうところ。そもそもインデントでTab文字を使うなといわれてしまうとそれまでなんだけれども、すべてのエディタで自動変換してくれるとは限らないのでこれはパーサで変換してもらいたい。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-php" data-lang="php"><span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">consumeFencedCode</span><span class="hljs-params">(<span class="hljs-variable">$lines</span>, <span class="hljs-variable">$current</span>)</span>
</span>{
    <span class="hljs-variable">$line</span> = rtrim(<span class="hljs-variable">$lines</span>[<span class="hljs-variable">$current</span>]);
    <span class="hljs-variable">$fence</span> = substr(<span class="hljs-variable">$line</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">$pos</span> = strrpos(<span class="hljs-variable">$line</span>, <span class="hljs-variable">$line</span>[<span class="hljs-number">0</span>]) + <span class="hljs-number">1</span>);
    <span class="hljs-variable">$language</span> = substr(<span class="hljs-variable">$line</span>, <span class="hljs-variable">$pos</span>);
    <span class="hljs-variable">$content</span> = [];

    <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-variable">$current</span> + <span class="hljs-number">1</span>, <span class="hljs-variable">$count</span> = count(<span class="hljs-variable">$lines</span>); <span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$count</span>; <span class="hljs-variable">$i</span>++)
    {
        <span class="hljs-keyword">if</span> (rtrim(<span class="hljs-variable">$line</span> = <span class="hljs-variable">$lines</span>[<span class="hljs-variable">$i</span>]) !== <span class="hljs-variable">$fence</span>)
        {
            <span class="hljs-variable">$content</span>[] = strstr(<span class="hljs-variable">$line</span>, <span class="hljs-string">"\t"</span>) ? str_replace(<span class="hljs-string">"\t"</span>, <span class="hljs-string">'    '</span>, <span class="hljs-variable">$line</span>) : <span class="hljs-variable">$line</span>;
        }
        <span class="hljs-keyword">else</span>
        {
            <span class="hljs-keyword">break</span>;
        }
    }

    <span class="hljs-variable">$block</span> = [
        <span class="hljs-string">'code'</span>,
        <span class="hljs-string">'content'</span> =&gt; implode(<span class="hljs-string">"\n"</span>, <span class="hljs-variable">$content</span>),
    ];

    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$language</span>))
    {
        <span class="hljs-variable">$block</span>[<span class="hljs-string">'language'</span>] = <span class="hljs-variable">$language</span>;
    }

    <span class="hljs-keyword">return</span> [<span class="hljs-variable">$block</span>, <span class="hljs-variable">$i</span>];
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>MarkdownではインデントがCodeBlockになるけれども、自分はFencedCodeBlock以外でコードを表記することは絶対にないのでそちらは修正していない。おそらく同じ処理がされているので使うのであればそちらも修正が必要になるはず。</p>
</div>
<div class="paragraph">
<p>シンタックスハイライトのために<code>&lt;pre&gt;</code>に独自の属性を追加しておく。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-php" data-lang="php"><span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">renderCode</span><span class="hljs-params">(<span class="hljs-variable">$block</span>)</span>
</span>{
    <span class="hljs-variable">$class</span> = <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$block</span>[<span class="hljs-string">'language'</span>]) ? <span class="hljs-string">' class="language-'</span> . <span class="hljs-variable">$block</span>[<span class="hljs-string">'language'</span>] . <span class="hljs-string">'"'</span> : <span class="hljs-string">''</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-string">'&lt;pre prism&gt;'</span> . <span class="hljs-string">"&lt;code$class&gt;"</span> . htmlspecialchars(<span class="hljs-variable">$block</span>[<span class="hljs-string">'content'</span>] . <span class="hljs-string">"\n"</span>, ENT_NOQUOTES | ENT_SUBSTITUTE, <span class="hljs-string">'UTF-8'</span>) . <span class="hljs-string">"&lt;/code&gt;&lt;/pre&gt;\n"</span>;
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="generate-toc">ページ内メニューを生成する</h2>
<div class="sectionbody">
<div class="paragraph">
<p>最初はJavaScriptでやろうかなと思っていたんだけど、このパーサであれば簡単にMarkdownからページ内メニューの生成ができそうだったのでサーバサイドでやることにした。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-php" data-lang="php"><span class="hljs-keyword">private</span> <span class="hljs-variable">$menu</span> = [];
<span class="hljs-keyword">private</span> <span class="hljs-variable">$max_level</span> = <span class="hljs-number">7</span>;

<span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">renderHeadline</span><span class="hljs-params">(<span class="hljs-variable">$block</span>)</span>
</span>{
    <span class="hljs-variable">$level</span> = intval(<span class="hljs-variable">$block</span>[<span class="hljs-string">'level'</span>]);

    <span class="hljs-comment">// 最大レベルの調整</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$this</span>-&gt;max_level &gt; <span class="hljs-variable">$level</span>)
    {
        <span class="hljs-variable">$this</span>-&gt;max_level = <span class="hljs-variable">$level</span>;
    }

    <span class="hljs-variable">$render</span> = <span class="hljs-variable">$this</span>-&gt;renderAbsy(<span class="hljs-variable">$block</span>[<span class="hljs-string">'content'</span>]);

    <span class="hljs-comment">// id出力用データ追加</span>
    <span class="hljs-variable">$html_id</span> = <span class="hljs-variable">$this</span>-&gt;id_prefix . str_replace([<span class="hljs-string">' '</span>, <span class="hljs-string">'#'</span>], <span class="hljs-string">'_'</span>, mb_convert_kana(strip_tags(<span class="hljs-variable">$render</span>), <span class="hljs-string">'asK'</span>));

    <span class="hljs-variable">$tail</span> = <span class="hljs-string">''</span>;
    <span class="hljs-variable">$count</span> = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$this</span>-&gt;menu <span class="hljs-keyword">as</span> <span class="hljs-variable">$value</span>)
    {
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$html_id</span> . <span class="hljs-variable">$tail</span> === <span class="hljs-variable">$value</span>[<span class="hljs-number">2</span>])
        {
            <span class="hljs-variable">$tail</span> = <span class="hljs-string">"-{$count}"</span>;
            <span class="hljs-variable">$count</span>++;

            <span class="hljs-keyword">continue</span>;
        }
    }

    <span class="hljs-variable">$html_id</span> .= <span class="hljs-variable">$tail</span>;

    <span class="hljs-variable">$this</span>-&gt;menu[] = [<span class="hljs-variable">$level</span>, <span class="hljs-variable">$render</span>, <span class="hljs-variable">$html_id</span>];

    <span class="hljs-variable">$tag</span> = <span class="hljs-string">'h'</span> . <span class="hljs-variable">$block</span>[<span class="hljs-string">'level'</span>];
    <span class="hljs-keyword">return</span> <span class="hljs-string">"&lt;$tag id=\""</span> . <span class="hljs-variable">$html_id</span> . <span class="hljs-string">"\"&gt;$render&lt;/$tag&gt;\n"</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>フィールドに空の配列と、Markdown内で使用されているもっとも大きいHeadingのレベルを保存しておく変数を用意する。<code>renderHeadline</code>内でレベルを取得しつつ、<code>$menu</code>にHeadingのレベルとタイトルを追加していく。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-php" data-lang="php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createMenu</span><span class="hljs-params">(<span class="hljs-variable">$url</span> = <span class="hljs-string">''</span>)</span>
</span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$this</span>-&gt;menu))
    {
        <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
    }

    <span class="hljs-variable">$result</span> = <span class="hljs-string">'&lt;ol&gt;'</span>;

    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$this</span>-&gt;menu <span class="hljs-keyword">as</span> <span class="hljs-variable">$value</span>)
    {
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$value</span>[<span class="hljs-number">0</span>] === <span class="hljs-variable">$this</span>-&gt;max_level)
        {
            <span class="hljs-variable">$href</span> = <span class="hljs-string">"{$url}#{$value[2]}"</span>;
            <span class="hljs-variable">$result</span> .= <span class="hljs-string">"&lt;li du-scrollspy=\"{$href}\"&gt;&lt;a href=\"{$href}\" du-smooth-scroll&gt;{$value[1]}&lt;/a&gt;&lt;/li&gt;"</span>;
        }
    }

    <span class="hljs-variable">$result</span> .= <span class="hljs-string">'&lt;/ol&gt;'</span>;

    <span class="hljs-keyword">return</span> <span class="hljs-variable">$result</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>配列が空なら即リターン。中身があればもっとも大きいHeadingのレベルだけを抽出してリストにしています。</p>
</div>
</div>
</div></div></div></article>