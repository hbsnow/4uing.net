<article class="main-root"><header class="content-header"><nav id="breadcrumb"><div class="container"><div itemscope="itemscope" itemtype="http://data-vocabulary.org/Breadcrumb"><a href="/blog.html" itemprop="url"><span itemprop="title">Blog</span></a></div></div></nav><div class="content-header-title"><div class="container"><h1 id="main-title">CSSのスコープ</h1></div></div><div class="content-header-meta"><div class="container"><div id="article-date"><div id="article-date-created"><time>2015-01-25</time></div><hr/><div id="article-date-updated"><time>2015-04-02</time></div></div><div id="article-tags"><ul><li><a href="/blog/tag/CSS.html" class="button">CSS</a></li><li><a href="/blog/tag/Web-Components.html" class="button">Web Components</a></li></ul></div><div id="article-toc"><div class="container"><ol><li><a href="#attr-scoped">scoped属性</a></li><li><a href="#css-scoping-module">CSS Scoping Module</a><ol><li><a href="#scoped-styles">Scoped Styles</a></li></ol></li><li><a href="#shadow-dom">Shadow Encapsulation</a></li><li><a href="#bibliography">参照文献</a></li></ol></div></div></div></div></header><div class="content-body"><div class="container"><div class="paragraph">
<p>この記事の内容についてのほとんどが対応ブラウザの少ないものなので、現段階でそのまま実際に使えるものではない。Polymerで使用されているCSSを初見でわりと理解できなかったかつての自分用メモです。Polymerの解説ではなくて仕様の整理なので注意。</p>
</div>
<div class="sect1">
<h2 id="attr-scoped">scoped属性</h2>
<div class="sectionbody">
<div class="paragraph">
<p>これは直感的でわかりやすくて、HTML内部に直接<code>style</code>要素を挿入して<code>scoped</code>属性をつけるだけ。<code>scoped</code>属性をもつ要素はフローコンテンツが許容される最初の子要素である必要があって、場合によってはその<code>style</code>要素をラップする親要素が必要になることもある。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html"><span class="hljs-tag">&lt;<span class="hljs-title">p</span>&gt;</span>この文章にはスタイルが適用されません。<span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">style</span> <span class="hljs-attribute">scoped</span>&gt;</span><span class="css">
        <span class="hljs-tag">p</span> <span class="hljs-rules">{ <span class="hljs-rule"><span class="hljs-attribute">color</span>:<span class="hljs-value"> red</span></span>; }</span>
    </span><span class="hljs-tag">&lt;/<span class="hljs-title">style</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">p</span>&gt;</span>この文章は文字が赤くなります。<span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>嫌がらせ以外で誰が使うんだろうかとおもっていたんだけども、後日<a href="http://0-9.sakura.ne.jp/pub/kbkz_tech/start.html">CSSに死を！これはJSerの叫び！</a>のスライドを見ていて、JavaScriptの中にスタイルを埋め込んでしまいたいときに使いたくなるということがわかった。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="css-scoping-module">CSS Scoping Module</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Polymerを使ってる人はすでに使っているはず。<code>core-*</code>に含まれるCSSの<code>:host</code>とか<code>/deep/</code>がそれ。念のためすべて確認しておきます。</p>
</div>
<div class="sect2">
<h3 id="scoped-styles">Scoped Styles</h3>
<div class="paragraph">
<p>仕様書の順番通りにいくとまずは<code>@scope</code>。これは<code>scoped</code>属性と似たようなものなのだけれど、HTMLにそれほど干渉せずに指定できる。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html"><span class="hljs-tag">&lt;<span class="hljs-title">p</span>&gt;</span>この文章にはスタイルが適用されません。<span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">p</span>&gt;</span>この文章は文字が赤くなります。<span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>このHTMLのdivでスコープを作りたいようなときには以下のようにCSSを記述する。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-css" data-lang="css"><span class="hljs-at_rule">@<span class="hljs-keyword">scope</span> div </span>{
    <span class="hljs-tag">p</span> <span class="hljs-rules">{ <span class="hljs-rule"><span class="hljs-attribute">color</span>:<span class="hljs-value"> red</span></span>; }</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>class</code>や<code>id</code>つければいいだけなんじゃないかといわれるとそこまでなんだけど、そのスタイルを作成した作者の<strong>このスタイルはそのコンテンツ内でしか使用しないですよ</strong>という意図を明示することに意味があるのかもしれない。あとはCSSでネストされてると見通しがいいような気はするんだけど、いまどきCSS直接書く人なんていないだろうからそれがメリットになることはないよね。</p>
</div>
<div class="paragraph">
<p>それとこれは以下のようにも書けるということらしいんだけど、Issueになっていて色々な記法が提案されてるみたいだから、仕様だけみても今後どうなるかはわからないっぽい。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-css" data-lang="css"><span class="hljs-rule"><span class="hljs-attribute">p</span>:<span class="hljs-value"><span class="hljs-function">scope-context</span>(div) {
    color: red</span></span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>:scope</code>についてはよくわからない。<a href="http://www.w3.org/TR/selectors4/">CSS Selector 4</a>にあるらしいので、気になる人は確認してみるといいと思う。確認してないけど、たぶんスコープをもっている要素を選択できるとかそんな感じじゃないかな。</p>
</div>
<div class="paragraph">
<p>これらはどうせ対応ブラウザはないだろうから覚えておく必要なんてない。そもそも対応したってScoped Stylesでわざわざこんなスコープ作る人なんていないんじゃないだろうか、少なくとも自分は絶対に使わない。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="shadow-dom">Shadow Encapsulation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>こちらが本命。CSSのスコープといっているのにShadow DOMを使わないのは意味がわからない。</p>
</div>
<div class="paragraph">
<p>これ以降の内容はShadow DOMだけでなくWeb Componentsについて理解していないと、何が書いてあるのかさっぱり理解できないはず。Web Componentsについては<a href="http://4uing.net/blog/md-web-components-polymer/">以前少しだけ解説</a>しています。</p>
</div>
<div class="paragraph">
<p>まずは<code>:host</code>。これはshasow treeのコンテキストで評価されたときhost elementと一致する。言葉でみると何を言っているのかよくわからないんだけど、仕様書のサンプルをみるとそんなに難しいことを言っているわけでもないことがわかる。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html"><span class="hljs-tag">&lt;<span class="hljs-title">x-foo</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"foo"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">"shadow</span> <span class="hljs-attribute">tree</span>"&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"foo"</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">x-foo</span>&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>コンポーネントがこのようなshadow treeを持つときには以下のようになる。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-css" data-lang="css"><span class="hljs-pseudo">:host</span> <span class="hljs-rules">{}</span>       // &lt;<span class="hljs-tag">x-foo</span>&gt;を選択する
<span class="hljs-tag">x-foo</span> <span class="hljs-rules">{}</span>       // 何とも一致しない
<span class="hljs-class">.foo</span> <span class="hljs-rules">{}</span>        // &lt;<span class="hljs-tag">div</span>&gt;要素のみを選択する
<span class="hljs-rule"><span class="hljs-attribute">.foo</span>:<span class="hljs-value">host {}   // 何とも一致しない
:<span class="hljs-function">host</span>(.foo) {} // &lt;x-foo&gt;を選択する</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>簡単に要約してしまうとshadow treeの外側にある<code>&lt;x-foo&gt;</code>選択できないから<code>:host</code>って書けばいいよ、ということ。</p>
</div>
<div class="paragraph">
<p><code>:host-context()</code>ではshadow treeの外の祖先の要素を指定することもできて、これはテーマで配色を変更したりするようなときに便利ということらしいです。仕様にそう書いてあるからね。</p>
</div>
<div class="paragraph">
<p><code>:shadow</code>はセレクタで使用するためのshadow treeのルートを選択するもので、shadow treeを複数持っていた場合にはすべてのshadow treeを選択する。つまり<code>:host::shadow div</code>みたいなことをすると、そのホスト要素内にあるすべてのshadow tree内の<code>div</code>を選択することになる。</p>
</div>
<div class="paragraph">
<p><code>::content</code>についても仕様のサンプルがわかりやすい。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html"><span class="hljs-tag">&lt;<span class="hljs-title">x-foo</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"one"</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"foo"</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"two"</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"three"</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"foo"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"four"</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">"shadow</span> <span class="hljs-attribute">tree</span>"&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"five"</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"six"</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">content</span> <span class="hljs-attribute">select</span>=<span class="hljs-value">".foo"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">content</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">"shadow</span> <span class="hljs-attribute">tree</span>"&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">x-foo</span>&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>::content div</code>とすると選択されるのは<code>#one</code>, <code>#three</code>, <code>#four</code>になって、<code>::content &gt; div</code>とすると<code>#four</code>のみが選択される。Polymerを使うなら<code>polyfill-next-selector</code>。</p>
</div>
<div class="paragraph">
<p><code>/deep/</code>はshadow rootをまたいで要素を指定できる。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html"><span class="hljs-tag">&lt;<span class="hljs-title">x-foo</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">"shadow</span> <span class="hljs-attribute">tree</span>"&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">span</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"not-top"</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">span</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"top"</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">x-bar</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">"shadow</span> <span class="hljs-attribute">tree</span>"&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">span</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"nested"</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span>
            <span class="hljs-tag">&lt;/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-title">x-bar</span>&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">x-foo</span>&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>x-foo /deep/ span</code>とすると選択されるのは<code>#top</code>, <code>#not-top</code>, <code>#nested</code>になる。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="bibliography">参照文献</h2>
<div class="sectionbody">
<div class="ulist bibliography">
<ul class="bibliography">
<li>
<p><a href="http://www.w3.org/TR/html51/">HTML 5.1</a></p>
</li>
<li>
<p><a href="http://www.w3.org/TR/css-scoping-1/">CSS Scoping Module</a></p>
</li>
</ul>
</div>
</div>
</div></div></div></article>