<article class="main-root"><header class="content-header"><nav id="breadcrumb"><div class="container"><div itemscope="itemscope" itemtype="http://data-vocabulary.org/Breadcrumb"><a href="/blog.html" itemprop="url"><span itemprop="title">Blog</span></a></div></div></nav><div class="content-header-title"><div class="container"><h1 id="main-title">gulpでbrowserifyを使う</h1></div></div><div class="content-header-meta"><div class="container"><div id="article-date"><div id="article-date-created"><time>2014-11-19</time></div><hr/><div id="article-date-updated"><time>2015-04-28</time></div></div><div id="article-tags"><ul><li><a href="/blog/tag/JavaScript.html" class="button">JavaScript</a></li><li><a href="/blog/tag/gulp.html" class="button">gulp</a></li></ul></div><div id="article-toc"><div class="container"><ol><li><a href="#browserify">browserify</a><ol><li><a href="#browserify-install">インストール</a></li><li><a href="#browserify-gulpfile">gulpfile.js</a></li></ol></li><li><a href="#watchify">watchify</a><ol><li><a href="#watchify-install">インストール</a></li><li><a href="#watchify-gulpfile">gulpfile.js</a></li></ol></li><li><a href="#bibliography">参照文献</a></li></ol></div></div></div></div></header><div class="content-body"><div class="container"><div class="paragraph">
<p><a href="http://gulpjs.com/">gulp</a>で<a href="http://browserify.org/">browserify</a>を使って、Web開発で使用するモジュールを管理する。何がいいのかというとコード内にコードの依存関係を<code>require</code>で記述できることだとおもう。</p>
</div>
<div class="paragraph">
<p>同じことはwebpackでもできるので、<a href="http://4uing.net/blog/gulp-webpack">webpackをつかうことも</a>あります。ただwebpackはできることが多すぎるので、そこまでの高性能を望まないのであればbrowserifyで問題ありません。</p>
</div>
<div class="sect1">
<h2 id="browserify">browserify</h2>
<div class="sectionbody">
<div class="paragraph">
<p>以前はgulp-browserifyを使っていたんだけれども、https://github.com/gulpjs/plugins/blob/master/src/blackList.json[BlackList]に含まれていて推奨されない方法とされているので、直接browserifyを使います。</p>
</div>
<div class="paragraph">
<p>gulpのレシピにある<a href="https://github.com/gulpjs/gulp/blob/master/docs/recipes/browserify-uglify-sourcemap.md">Browserify + Uglify2 with sourcemaps</a>あたりが参考になりそうです。</p>
</div>
<div class="sect2">
<h3 id="browserify-install">インストール</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ps1" data-lang="ps1">npm init
npm install gulp bower debowerify browserify vinyl-transform --save-dev</code></pre>
</div>
</div>
<div class="paragraph">
<p>Web用のパッケージはlinkhttp://bower.io/[bower]でしか管理されていないこともあるのでいれておきました。<a href="https://github.com/eugeneware/debowerify">debowerify</a>はbowerで取得したファイルを簡略な指定によってbrowserifyで使うためのもので<code>package.json</code>に以下を追記する必要があります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json"><span class="hljs-string">"browserify"</span>: {
  "<span class="hljs-attribute">transform</span>": <span class="hljs-value">[
    <span class="hljs-string">"debowerify"</span>
  ]
</span>},</code></pre>
</div>
</div>
<div class="paragraph">
<p>bowerのファイルがプロジェクトのルート直下にあると邪魔なので<code>.bowerrc</code>を作成してappディレクトリに移動しておきました。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
  "<span class="hljs-attribute">directory</span>": <span class="hljs-value"><span class="hljs-string">"/app/bower_components"</span>
</span>}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="browserify-gulpfile">gulpfile.js</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js"><span class="hljs-keyword">var</span> gulp = <span class="hljs-built_in">require</span>(<span class="hljs-string">'gulp'</span>);
<span class="hljs-keyword">var</span> transform = <span class="hljs-built_in">require</span>(<span class="hljs-string">'vinyl-transform'</span>);
<span class="hljs-keyword">var</span> browserify = <span class="hljs-built_in">require</span>(<span class="hljs-string">'browserify'</span>);

gulp.task(<span class="hljs-string">'js'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> gulp.src(<span class="hljs-string">'app/scripts/main.js'</span>)
    .pipe(transform(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">filename</span>) </span>{
      <span class="hljs-keyword">return</span> browserify(filename, {
        debug: <span class="hljs-literal">true</span>
      }).bundle();
    }))
    .pipe(gulp.dest(<span class="hljs-string">'dist'</span>));
});</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>vinyl-transform</code>は<code>bundle</code>の返すファイルストリームをnpmで使用されているvinylに変換するために使われている。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="watchify">watchify</h2>
<div class="sectionbody">
<div class="paragraph">
<p>browserifyで<code>watch</code>していると、ファイルの増加によってその処理時間もどんどん増えてくので<code>watch</code>のときにはWatchifyで差分コンパイルをします。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/gulpjs/gulp/blob/master/docs/recipes/fast-browserify-builds-with-watchify.md">Fast browserify builds with watchify</a></p>
</li>
<li>
<p><a href="http://akabeko.me/blog/2015/02/watchify/">watchify を試す | アカベコマイリ</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>上記のサイトを参考にしました。</p>
</div>
<div class="sect2">
<h3 id="watchify-install">インストール</h3>
<div class="paragraph">
<p>browserifyがインストール済みであることを想定しています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ps1" data-lang="ps1">npm install watchify vinyl-source-stream gulp-util --save-dev</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>gulp-util</code>は必須ではないんだけど、出力されるログは色がついていたほうがわかりやすいので使いました。</p>
</div>
</div>
<div class="sect2">
<h3 id="watchify-gulpfile">gulpfile.js</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js"><span class="hljs-keyword">var</span> gulp = <span class="hljs-built_in">require</span>(<span class="hljs-string">'gulp'</span>);
<span class="hljs-keyword">var</span> source = <span class="hljs-built_in">require</span>(<span class="hljs-string">'vinyl-source-stream'</span>);
<span class="hljs-keyword">var</span> browserify = <span class="hljs-built_in">require</span>(<span class="hljs-string">'browserify'</span>);
<span class="hljs-keyword">var</span> watchify   = <span class="hljs-built_in">require</span>(<span class="hljs-string">'watchify'</span>);
<span class="hljs-keyword">var</span> $ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'gulp-load-plugins'</span>)();

gulp.task(<span class="hljs-string">'browserify'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> compile(<span class="hljs-literal">false</span>);
});

gulp.task(<span class="hljs-string">'watchify'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> compile(<span class="hljs-literal">true</span>);
});

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">compile</span>(<span class="hljs-params">watch</span>) </span>{
  <span class="hljs-keyword">var</span> bundler = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> option = {
    debug: <span class="hljs-literal">true</span>
  };

  <span class="hljs-keyword">if</span>(watch) {
    option.cache = {};
    option.packageCache = {};
    option.fullPaths = <span class="hljs-literal">true</span>;
    bundler = watchify(browserify(path.js, option));
  } <span class="hljs-keyword">else</span> {
    bundler = browserify(path.js, option);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">bundle</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> bundler
      .bundle()
      .on(<span class="hljs-string">'error'</span>, $.util.log.bind($.util, <span class="hljs-string">'Browserify Error'</span>))
      .pipe(source(<span class="hljs-string">'main.js'</span>))
      .pipe(gulp.dest(path.dist));
  }

  bundler.on(<span class="hljs-string">'update'</span>, bundle);
  bundler.on(<span class="hljs-string">'log'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">msg</span>) </span>{
    $.util.log(<span class="hljs-string">'Finished'</span>, <span class="hljs-string">'\''</span> + $.util.colors.cyan(<span class="hljs-string">'watchify'</span>) + <span class="hljs-string">'\''</span>, msg);
  });

  <span class="hljs-keyword">return</span> bundle();
}

gulp.task(<span class="hljs-string">'watch'</span>, [<span class="hljs-string">'watchify'</span>], <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-comment">//watchifyは監視しなくていい</span>
});</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="bibliography">参照文献</h2>
<div class="sectionbody">
<div class="ulist bibliography">
<ul class="bibliography">
<li>
<p><a href="https://github.com/mjhea0/angular-gulp-browserify-seed">angular-gulp-browserify-seed</a></p>
</li>
<li>
<p><a href="http://stackoverflow.com/questions/25088406/cant-get-external-library-with-browserify-and-debowerify">javascript - Can't get external library with browserify and debowerify - Stack Overflow</a></p>
</li>
<li>
<p><a href="http://umai-bow.hateblo.jp/entry/2014/10/08/002235">gulp と browserify と vinyl の話</a></p>
</li>
<li>
<p><a href="http://akabeko.me/blog/2015/02/watchify/">watchify を試す | アカベコマイリ</a></p>
</li>
</ul>
</div>
</div>
</div></div></div></article>