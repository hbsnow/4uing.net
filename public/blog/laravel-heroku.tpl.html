<article class="main-root"><header class="content-header"><nav id="breadcrumb"><div class="container"><div itemscope="itemscope" itemtype="http://data-vocabulary.org/Breadcrumb"><a href="/blog.html" itemprop="url"><span itemprop="title">Blog</span></a></div></div></nav><div class="content-header-title"><div class="container"><h1 id="main-title">Laravelで作ったブログをHerokuで公開する</h1></div></div><div class="content-header-meta"><div class="container"><div id="article-date"><div id="article-date-created"><time>2014-11-16</time></div><hr/><div id="article-date-updated"><time>2015-05-28</time></div></div><div id="article-tags"><ul><li><a href="/blog/tag/PHP.html" class="button">PHP</a></li><li><a href="/blog/tag/Laravel.html" class="button">Laravel</a></li><li><a href="/blog/tag/heroku.html" class="button">heroku</a></li></ul></div><div id="article-toc"><div class="container"><ol><li><a href="#install">インストール</a></li><li><a href="#ssh-key">SSHの公開鍵の設定</a></li><li><a href="#_app_laravel">App作成とLaravelの設定変更</a></li><li><a href="#deploy">公開</a></li><li><a href="#domain">独自ドメインの適用</a><ol><li><a href="#dozens">Dozens</a></li></ol></li><li><a href="#laravel5-deploy-error">Laravel5をデブロイしたときに発生するエラー</a></li><li><a href="#bibliography">参照文献</a></li></ol></div></div></div></div></header><div class="content-body"><div class="container"><div class="paragraph">
<p>どこかのPaaSにLaravelで作ったブログを公開したかったので、使用するPaaSの条件をいくつか考えてみました。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Laravel(PHP)が使用できること</p>
</li>
<li>
<p>無料で使用できること</p>
</li>
<li>
<p>独自ドメインが使用できること</p>
</li>
<li>
<p>データベースがPostgreSQLもしくはMySQL</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>これらを条件にすると残る自分の知っているPaaSで、以前であれば<a href="https://heroku.com/">Heroku</a>があったのですが、現在HerokuのFreeプランではこの条件に合致しなくなっています。Freeの場合一日に数時間のsleepが必要になるため、今回のようなブログ用途には不向きです。今であれば無料が前提であるならば、<a href="https://www.openshift.com/">OpenShift</a>あたりになるとおもいます。</p>
</div>
<div class="paragraph">
<p>今回は当時使っていたherokuにLaravel製のブログをアップロードする方法の解説です。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/hbsnow/laravel5-blog">hbsnow/laravel5-blog</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>使用したブログのコードはGitHubで公開しています。</p>
</div>
<div class="sect1">
<h2 id="install">インストール</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://devcenter.heroku.com/articles/getting-started-with-php">Getting Started with PHP on Heroku</a>をある程度すすめていき、アカウント作成とToolbeltのダウンロードとインストールします。Windowsを使っていたので<a href="https://chocolatey.org/packages/heroku-toolbelt">chocolatey</a>を使おうとしたんだけど、残念ながらパッケージのメンテナンスはされてなかったので素直に公式からダウンロード。インストール後はなんとなく不安だったので再起動。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ssh-key">SSHの公開鍵の設定</h2>
<div class="sectionbody">
<div class="paragraph">
<p>git bashで公開鍵を作成します。以降のコマンドはすべてgit bashで実行しています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"><span class="hljs-built_in">cd</span> ~/.ssh
ssh-keygen -t rsa</code></pre>
</div>
</div>
<div class="paragraph">
<p>これでSSH Keyが作成されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">heroku login</code></pre>
</div>
</div>
<div class="paragraph">
<p>指示に従っていけば先ほど作成したSSHの公開鍵が登録されます。今回は他にSSH Keyが何もないPCで作成したのでとくに設定することはなかったんだけど、他にSSH Keyがあるとまた別に設定が必要になるかも。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_app_laravel">App作成とLaravelの設定変更</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Laravelの必要な場所を変更する前にまずAppを作成します。これを先にやってしまわないとURLの記述の変更ができません。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">git init
heroku create Appの名前</code></pre>
</div>
</div>
<div class="paragraph">
<p>Appの作成をダッシュボードで確認して、ついでにデータベースを作成します。データベースはHobby-devという無料プランを選択。</p>
</div>
<div class="paragraph">
<p>これでLaravelの設定変更に必要な情報が揃ったので、設定を書き換えることができるようになりました。使用しているLaravelの設定を変更しましょう。</p>
</div>
<div class="paragraph">
<p>Laravel4では<code>.gitignore</code>に<code>composer.lock</code>が含まれているので削除しておきます。またドキュメントのルートを変更するためにプロジェクト直下に<code>Procfile</code>というファイルを追加して、以下の内容を追記しておきます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">web: vendor/bin/heroku-php-apache2 public</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploy">公開</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">git add . -A
git commit -m <span class="hljs-string">"first commit"</span>
git push heroku master</code></pre>
</div>
</div>
<div class="paragraph">
<p>あとはローカルと同じようにマイグレーションとシーディングを実行します。ついでにタイムゾーンも日本のものに変更しました。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">heroku config:add TZ=Asia/Tokyo
heroku run php artisan migrate
heroku run php db:seed</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="domain">独自ドメインの適用</h2>
<div class="sectionbody">
<div class="paragraph">
<p>独自ドメインを使いたいのでその設定をします。ドメインはValue Domainを使っているけれども、他のサービスでもやることはあまり変わらないはず。</p>
</div>
<div class="paragraph">
<p>ただしHerokuでルートドメインを使用するためにはひとてま必要で、他のサービスを併用するか<a href="https://addons.heroku.com/zerigo_dns">有料アドオン</a>を使う必要があります。</p>
</div>
<div class="paragraph">
<p>まずはHerokuにドメインを登録しておきます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">heroku domains:add ドメイン</code></pre>
</div>
</div>
<div class="paragraph">
<p>これで登録されてるのかとおもったけど、後になってダッシュボードを確認してみると追加されていなかったのでダッシュボードでも追加しておいた。ただダッシュボードだけで追加してもどうやら反映はされない、もしくはすぐされないようなのでコマンドも入力しておいたほうがいい。</p>
</div>
<div class="sect2">
<h3 id="dozens">Dozens</h3>
<div class="paragraph">
<p>他サービスを使ってルートドメインを使用するためにはApex Aliasを使う必要があるためValue Domainだけでは対応できないため、<a href="http://dozens.jp/i/5b1X5u">Dozens</a>や<a href="http://www.gehirn.jp/">Gehirn Web Services</a>のようなサービスを使用する必要がありません。</p>
</div>
<div class="paragraph">
<p>設定についてわからないことがあれば<a href="http://m.designbits.jp/14121021/">Herokuアプリのルートドメイン設定(Dozens + VALUE DOMAIN)</a>の解説がわかりやすいとおもいます。</p>
</div>
<div class="paragraph">
<p>Dozensで設定が終ったあとは<code>Appの名前.herokuapp.com</code>のアクセスを転送するため、<code>.htaccess</code>に以下の内容を追記しました。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>RewriteCond %{HTTP_HOST} ^xxx.herokuapp.com$
RewriteRule (.*) http://example.com/$1 [R=301,L]</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="laravel5-deploy-error">Laravel5をデブロイしたときに発生するエラー</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Laravel5をとくに設定を変更せずそのままデブロイしようとするとエラーが発生します。これは<code>package.json</code>があるとアプリケーションがNode.jsであると判別されるせいです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">heroku config:<span class="hljs-built_in">set</span> BUILDPACK_URL=https://github.com/heroku/heroku-buildpack-php</code></pre>
</div>
</div>
<div class="paragraph">
<p>PHPと認識させるためにはBuildpackをPHPに変更する必要があります。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="bibliography">参照文献</h2>
<div class="sectionbody">
<div class="ulist bibliography">
<ul class="bibliography">
<li>
<p><a href="https://devcenter.heroku.com/articles/getting-started-with-php">Getting Started with PHP on Heroku | Heroku Dev Center</a></p>
</li>
<li>
<p><a href="http://qiita.com/Tkashiro/items/8249455477bbb5333118">Express - herokuにルートドメインを無料で設定する - Qiita</a></p>
</li>
<li>
<p><a href="http://d.hatena.ne.jp/kitokitoki/20130127/p2">Heroku で日付時刻の表示(9時間ずれて表示される問題の対処) - わからん</a></p>
</li>
<li>
<p><a href="http://m.designbits.jp/14121021/">Herokuアプリのルートドメイン設定(Dozens + VALUE DOMAIN)</a></p>
</li>
<li>
<p><a href="http://qiita.com/mm36/items/343e23b60a5795997e88">Laravel5 を Heroku にデプロイ</a></p>
</li>
</ul>
</div>
</div>
</div></div></div></article>