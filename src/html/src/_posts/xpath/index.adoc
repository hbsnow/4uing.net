---
title: XPath入門
description: Xpathについての簡単な解説。
date: 2008-01-08
updated: 2015-06-09
tags: XSL
---

XPathはlink:http://www.w3.org/TR/xslt[XSLT]、link:http://www.w3.org/TR/WD-xptr[XPointer]とともに使用されます。XPathのおもな目的は、XML文書の任意の箇所を指定することです。この目的のため文字列や数値、boolean値の基本的な操作を提供します。



[[data-model]]
== データモデル

XPathはXML文書をツリーとして扱います。ノードはツリーの構成単位であり、Xpathではノードを次のようにいくつかの種類に分類することができます。

[[root-node]]
=== ルートノード

ツリーのルートとなるノードです。ルートノードはツリーのルート以外になることはありません。文書のルート要素はルートノードの子ノードとなります。

[[elem-node]]
=== 要素ノード

文書内の要素は全て要素ノードをもち、要素ノードはexpanded-nameをもちます。

expanded-nameはlink:http://www.w3.org/TR/REC-xml-names[XML Names]に従い、QNameを展開した形で得られます。QNameに接頭辞がなく、かつ適用できるデフォルトの名前空間もない場合、名前空間URIは`null`になります。

要素ノードの子ノードは、要素ノードやコメントノード、処理命令ノード、テキストノードです。

[[attr-node]]
=== 属性ノード

要素ノードは属性ノードの集合をもちます。それぞれの要素は属性ノードの親ノードになりますが、属性ノードはその親要素の子ノードにはなりません。

`xml:lang`や`xml:space`などのいくつかの属性は、子孫要素にある同じ名前の属性によってオーバーライドされる場合を除いて、その属性を持つ要素のすべての子孫要素に適用されます。 ただし、これはツリー内での属性ノードの位置に影響を与えるものではありません。

属性ノードはexpanded-nameとstring-valueをもちます。

string-valueはXMLで規定された方法で正規化された値であり、正規化した結果が長さ0の文字列になる属性を特別に扱うことはなく、それは結果としてstring-valueに長さ0の文字列を持つ属性トノードになっただけにすぎません。

[[ns-node]]
=== 名前空間ノード

要素は関連する名前空間ノードの集合をもちます。要素のスコープ内の互いに異なる名前空間接頭辞に１つずつ、そしてデフォルトの名前空間が要素のスコープ内にある場合には、デフォルトの名前空間に対して１つです。要素はこれらの名前空間ノードの親ノードになりますが、名前空間ノードは、その親要素の子ノードにはなりません。

要素が名前空間ノードを共有することはありません。従って異なる二つの要素ノードがある場合、片方の要素ノードの名前空間ノードはすべて、もう一つの要素ノードの名前空間ノードとは異なります。

名前空間ノードはexpanded-nameとstring-valueをもちます。

expanded-nameのローカルパートは名前空間接頭辞になります。またこのとき、デフォルトの名前空間の名前空間ノードの場合は空になります。そして名前空間URIは常に`null`になります。

string-valueは、名前空間接頭辞にバインドされている名前空間URIである。その名前空間URIが相対指定の場合には、展開された名前のネームスペースURIと同様に解決されなければなりません。

[[proccessor-node]]
=== 処理命令ノード

文書型宣言内に記述するものを除いて、すべての処理命令は処理命令ノードをもち、処理命令ノードはexpanded-nameとstring-valueをもちます。

expanded-nameのローカルパートは処理命令のターゲットになり、名前空間URIは`null`となります。

string-valueは、ターゲットといくつかの空白に続く処理命令の一部です。最後の`?>`はこのstring-valueには含まれません。

[[comment-node]]
=== コメントノード

文書型宣言内に記述するコメントを除き、すべてのコメントはコメントノードをもち、コメントノードはstring-valueをもちます。

string-valueは、コメントのコンテンツです。最初の`<!--`と最後の`-->`は含まれません。

[[text-node]]
=== テキストノード

文字データは可能な限り多くの文字データをテキストノードにグループ化します。つまりテキストノードは、テキストノードの兄弟をその直前または直後に持つことはありません。

テキストノードはstring-valueをもちます。

string-valueは、文字データです。テキストノードは常に少なくとも一文字のデータをもちます。

コメントや処理命令、属性値の内部にある文字はテキストノードを生成しません。



[[expanded-name]]
== expanded-name

expanded-nameはローカルパートと名前空間URIからなります。ローカルパートは文字列であり、名前空間URIは`null`または文字列のどちらかです。

XML文書で指定する名前空間URIは、フラグメント識別子を持つ相対指定で使用することもできます。しかし名前空間を処理するときには、相対URIを絶対URIに解決する必要があり、データモデル内のノードが持つexpanded-nameの名前空間URIは絶対指定になります。



[[location-path]]
== ロケーションパスとその構成

ロケーションパスはXPathの式の一つでありコンテキストノードからノード集合を選択するものです。

ロケーションパスはいくつかのロケーションステップで構成され、複数のロケーションステップでロケーションパスが記述される場合にはそれぞれのロケーションステップ間は`/`によって区切られます。

ロケーションステップは軸・ノードテスト・述語をもちます。軸とノードテストの間は二つのコロン`::`によって区切られ、0個以上の`[]`で表現された述語が続きます。

次の例ではaxisは軸、node-testはノードテスト、predicateは述語を表しています。実際にaxisという軸があるわけではありませんので注意してください。

[source]
----
axis::node-test[predicate]
----

軸はコンテキストノードと目的のノードの関係を表し、全ての軸は主ノード型をもちます。主ノード型はノードテストの対象によって限定されるノードの型のことです。

[cols="1m,3,1"]
|===
|軸の主ノード型|説明|主ノード型

|child
|コンテキストノードの子ノード。ロケーションステップから省略が可能であり、実質的に軸の標準値になります。
|要素

|descendant
|コンテキストノードの子孫ノード。
|要素

|parent
|コンテキストノードの親ノード。
|要素

|ancestor
|コンテキストノードの祖先ノード。
|要素

|following-sibling
|コンテキストノードの後ろにある兄弟ノード。コンテキストノードが属性ノード・名前空間ノードであれば軸は空になります。
|要素

|preceding-sibling
|コンテキストノードの前にある兄弟ノード。コンテキストノードが属性ノード・名前空間ノードであれば軸は空になります。
|要素

|following
|文書内の記述順でコンテキストノードの後ろにある子孫ノード・属性ノード・名前空間ノードを除く全てのノード。
|要素

|preceding
|文書内の記述順でコンテキストノードの前にある祖先ノード・属性ノード・名前空間ノードを除く全てのノード。
|要素

|attribute
|コンテキストノードの属性ノード。コンテキストノードが要素でなければ軸は空になります。
|属性

|namespace
|コンテキストノードの名前空間ノード。コンテキストノードが要素でなければ軸は空になります。
|名前空間

|self
|コンテキストノード。
|要素

|descendant-or-self
|コンテキストノードの子孫ノードとコンテキストノード自身。省略構文で`//`と記述することができます。
|要素

|ancestor-or-self
|コンテキストノードの祖先ノードとコンテキストノード自身。
|要素
|===

ロケーションパスの起点はルートノードからノード集合を指定する絶対ロケーションパス、そして任意のノードを起点とした相対ロケーションパスのどちらかです。

ノードテストは軸によって示されたノードに、要素名などの名前・ノード型・`*`による条件を加えます。`*`はその軸の主ノード型の全てのノードを選択します。

[horizontal]
`comment()`:: コメントノード
`text()`:: テキストノード
`processing-instruction()`:: 処理命令ノード
`node()`:: 全ての型のノード

述語は条件を示す式で表現されます。式は四つの型のいずれかで評価され、戻り値として`true/false`値を返し`true`と評価されたノードのみが選択されます。また述語は複数記述できますが記述された順にフィルタリングします、述語が必要なければ何も記述する必要はありません。

[horizontal]
node-set:: ロケーションパスは式として使用することができる。この式はパスが選択するノード集合を返す。
boolean:: ブール値型は二つの値`true`か`false`を返す。
number:: 浮動小数点数。
string:: ゼロ個以上の文字の並び。

述語に使用される演算子には優先順位があります。

[cols="1m,2,2m,6a,1"]
|===
||概要|例|例の説明|優先

|()
|グループ化
|a[@xml:id='b']
|`xml:id`属性が`b`である`a`要素。
|1

|[]
|条件で選別
|a[(@xml:id='b' or @xml:id='c') and d]
|`xml:id`属性が`b`か`c`であり、子要素に`d`を持つ`a`要素。
|2

|div
|除算
|number(a) div count(b)
|`a`要素の内容の数値を`b`要素の数で除算。
.3+|3

|mod
|剰余
|number(a) mod count(b)
|`a`要素の内容の数値を`b`要素の数で除算したときの余り。

|*
|乗算
|number(a) * count(b)
|`a`要素の内容の数値を`b`要素の数で乗算。

|+
|加算
|number(a) + number(b)
|`a`要素の内容の数値と`b`要素の内容の数値を加算。
.2+|4

|-
|減算
|number(a) - number(b)
|`a`要素の内容の数値と`b`要素の内容の数値を減算。

|>
|より大きい
|a[number(b) > 500]
|`b`要素の内容が`500`より大きい`a`要素。
.4+|5

|>=
|以上
|a[number(b) >= 500]
|`b`要素の内容が`500`以上の`a`要素。

|<
|より小さい
|a[number(b) < 500]
|`b`要素の内容が`500`より小さい`a`要素。

|{gt}=
|以下
|a[number(b) <= 500]
|`b`要素の内容が`500`以下の`a`要素。

|=
|等しい
|a[position()=last()]
|カレントノードが最後の`a`要素。
.2+|6

|!=
|等しくない
|a[position()!=last()]
|カレントノードが最後でない`a`要素。

|{vbar}
|結合
|@*{vbar}node()
|属性ノードと全ての型のノード。
|7

|not
|否定
|a[not(@xml:id='b' or @xml:id='c')]
|`a`要素の`xml:id`属性が`b`か`c`でないもの。
|8

|and
|論理積
|a[@xml:id='b' and @xml:lang='en']
|`xml:id`属性が`b`であり、`xml:lang`属性が`en`である`a`要素。
|9

|or
|論理和
|a[@xml:id='b' or @xml:id='c']
|`xml:id`属性が`b`か`c`である`a`要素。
|10
|===



[[example]]
== 省略構文を含むロケーションパスとその例

全てのロケーションパスは回りくどくはない冗長な構文で表現することもできますが、いくつかは省略構文を用いて簡潔に表現することも可能です。

[cols="2m,1m,7a"]
|===
|例|省略形|説明

|child::para
|para
|軸の`child`は省略できます。


|self::node()
|.
|コンテキストノードを選択する場合の`self::node()`は`.` と省略することができます。

|attribute::name
|@name
|軸の`attribute`は`@`に省略することができます。

|/descendant-or-self::node()/para
|//para
|`/descendant-or-self::node()/`は`//para`と省略することができます。これはコンテキストノードを含んだ配下全ての要素を選択します。

|child::para[position()=1]
|para[1]
|述語にカレントノードの位置のみが記述されている場合`position()=`を省略した形にすることができます。
|===


[[corelib]]
== コア関数ライブラリ

`()`内には必要であれば型が記述され出現する`?`は引数のオプションであり、ない場合は必須となります。

[[node-set-functions]]
=== ノード集合関数

[cols="2m,6a,1"]
|===
|関数|説明|返す値の型

|last()
|コンテキストノード集合内のノード数を返します。
|number

|position()
|コンテキストノード集合内での位置を返します。
|number

|count(node-set)
|引数に指定したノード集合に含まれるノード数を返します。
|number

|id(object)
|ユニークなIDによって要素を選択します。
|node-set

|local-name(node-set?)
|引数に指定したノード集合のドキュメント順で最初のノードの名前空間接頭辞を省いたローカル名を返します。
|string

|namespace-uri(node-set?)
|引数に指定したノード集合のドキュメント順で最初のノードの名前空間URIを返します。
|string

|name(node-set?)
|引数に指定したノード集合の、ドキュメント順で最初のノードの名前空間接頭辞が省かれない完全修飾された要素名を返します。
|string
|===

[[string-functions]]
=== 文字列関数

[cols="2m,6a,1"]
|===
|関数|説明|返す値の型

|string(object?)
|ノードの値をstring型に変換します。
|string

|concat(string, string, string*)
|引数を連続して返します。
|string

|starts-with(string, string)
|一番目の引数に指定した文字列が二番目の引数に指定した文字列で始まっている場合に`true`を返し、それ以外は`false`を返します。
|boolean

|contains(string, string)
|一番目の引数に指定した文字列が二番目の引数に指定した文字列が含まれてる場合に`true`を返し、それ以外は`false`を返します。
|boolean

|substring-before(string, string)
|二番目の引数に指定した文字列が一番目の引数に指定した文字列で最初に見つかった場合にその文字列よりも前にある文字列を返します。
|string

|substring-after(string, string)
|二番目の引数に指定した文字列が一番目の引数に指定した文字列で最初に見つかった場合にその文字列よりも後にある文字列を返します。
|string

|substring(string, number, number?)
|一番目の引数に指定した文字列のうち二番目の引数に指定した位置から始まる文字列を三番目の引数で指定した長さだけ返します。
|string

|string-lengtd(string?)
|文字列の文字数を返します。
|number

|normalize-space(string?)
|引数に指定した文字列の空白文字を除去、連続している場合には一個の空白文字に置き換えて返します。
|string

|translate(string, string, string)
|一番目の引数に指定した文字列に二番目の引数に指定した文字列の文字があった場合、その文字を三番目の引数に指定した文字列の対応する位置の文字に置き換えて返します。
|string
|===

[[boolean-functions]]
=== ブール関数

[cols="2m,6a,1"]
|===
|関数|説明|返す値の型

|boolean(object)
|引数をboolean型に変換します。
|boolean

|not(boolean)
|引数が`false`の場合に`true`を返し、それ以外は`false`を返します。
|boolean

|true()
|`true`を返します。
|boolean

|false()
|`false`を返します。
|boolean

|lang(string)
|指定されたコンテキストノードの`xml:lang`属性が引数と同じ言語・サブ言語であれば`true`を返し、それ以外は`false`を返します。
|boolean
|===

[[number-functions]]
=== 数値関数

[cols="2m,6a,1"]
|===
|関数|説明|返す値の型

|number(object?)
|ノードの値をnumber型に変換します。
|number

|sum(node-set)
|ノード集合に含まれる値の合計値。
|number

|floor(number)
|引数より小さい、最も大きな整数を返します。
|number

|ceiling(number)
|引数より大きい、最も小さい整数を返します。
|number

|round(number)
|引数に最も近い整数を返します。
|number
|===



[[bibliography]]
== 参照文献

[bibliography]
* http://www.w3.org/TR/xpath[XML Path Language (XPath) Version 1.0]
